# Работа интерцепторов и gRPC в SSO

В проекте SSO реализована система аутентификации и авторизации на основе gRPC с использованием интерцепторов. gRPC обеспечивает эффективную коммуникацию между клиентами и сервером, а интерцепторы позволяют перехватывать и обрабатывать запросы на различных этапах их жизненного цикла.

Основной компонент gRPC-сервера представлен структурой serverAPI, которая реализует интерфейс Auth. При создании сервера настраиваются различные интерцепторы, которые обеспечивают дополнительную функциональность и безопасность. Интерцепторы работают как middleware, обрабатывая запросы до и после их попадания в основной обработчик.

В системе реализованы несколько типов интерцепторов. Прежде всего, это интерцептор для логирования, который записывает информацию о каждом входящем запросе. Он фиксирует метод, который был вызван, и время выполнения запроса. Это помогает отслеживать работу системы и диагностировать проблемы.

Особое внимание уделено интерцептору аутентификации. Этот интерцептор проверяет наличие и валидность JWT-токена в метаданных запроса. Если токен отсутствует или недействителен, запрос отклоняется с соответствующей ошибкой. Это обеспечивает защиту от несанкционированного доступа к методам сервера.

Для обработки ошибок реализован специальный интерцептор, который перехватывает все ошибки, возникающие при обработке запросов. Он преобразует внутренние ошибки системы в понятные gRPC-статусы, что позволяет клиентам корректно обрабатывать различные ситуации. Например, ошибка отсутствия пользователя преобразуется в статус NotFound.

В системе также реализован интерцептор для метрик, который собирает статистику о работе сервера. Он отслеживает количество запросов, время их обработки и количество ошибок. Эта информация может использоваться для мониторинга производительности и состояния системы.

При регистрации сервера в gRPC используется функция Register, которая связывает реализацию serverAPI с gRPC-сервером. При этом настраиваются все необходимые интерцепторы в правильном порядке. Порядок важен, так как интерцепторы выполняются последовательно, и каждый может влиять на результат обработки запроса.

Важной особенностью реализации является поддержка контекста запросов. Каждый запрос имеет свой контекст, который передается через все интерцепторы и обработчики. В контексте может храниться дополнительная информация, такая как идентификатор пользователя или метаданные запроса. Это позволяет эффективно передавать данные между различными компонентами системы.

Система также поддерживает потоковую передачу данных через gRPC. Это реализовано с помощью специальных методов, которые используют потоки для передачи данных между клиентом и сервером. При этом интерцепторы также работают с потоковыми запросами, обеспечивая их обработку на всех этапах.

Для оптимизации производительности в системе используется пул соединений. Это позволяет эффективно переиспользовать соединения между клиентами и сервером, что снижает накладные расходы на создание новых соединений. Интерцепторы также учитывают это при обработке запросов.

В процессе работы с gRPC реализована корректная обработка таймаутов и отмены операций. Это особенно важно для распределенных систем, где сетевые задержки могут существенно влиять на производительность. Интерцепторы помогают контролировать время выполнения запросов и корректно обрабатывать их отмену.

Система построена с учетом принципов чистой архитектуры, что обеспечивает четкое разделение ответственности между компонентами. Интерцепторы и gRPC-сервер являются частью инфраструктурного слоя, что позволяет легко модифицировать их реализацию без влияния на бизнес-логику системы. 